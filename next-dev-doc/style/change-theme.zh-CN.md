---
title: Change theme online
order: 1
group:
  title: style
  path: /style
  order: 2
nav:
  title: Front-end best practices
  path: /doc
  order: 100
---

# Change theme online

In the v4 version of pro, an online theme change function has been added. The original intention of this function is to allow designers to modify the main color of Ant Design more quickly, and preview it directly to save developers time. However, due to the immaturity of the solution, many students encountered problems during development, but they were unable to troubleshoot the problems. A lot of time was wasted in vain, so we wrote this short article to explain our implementation plan and why it caused this problem.

## Background

In order to simplify the use of less in Pro, [`css-module` ](https://github.com/css-modules/css-modules) is enabled. If used in a project, `css-module` is a great Features, it can solve the problem that plagues every programmer, how to make a meaningful but not repeated css class name.

But for the component css-module will increase the cost, if you want to keep the less source code when releasing the component, it will be more troublesome. First of all, even if you don't keep less. The class name of the component changes every time. In this way, you cannot use CSS to modify the style of the component.

> Some components that do not want to be modified can use `css-module`, each version is a new className, effectively preventing tampering.

The plug-in for online theme change is mainly realized by compiling less in the browser. First, he finds all the less of the project and extracts the selector with less variables. Combine it into a new less, which is color.less, and compile it with less.js in the browser, and then overwrite the original attributes. It is completed by the following three steps:

## Merge less

This function is mainly realized by a plug-in, `antd-pro-merge-less`, this plug-in will scan all the less in src and merge them into one `./temp/ant-design-pro.ess`, this Plug-ins are also the most problematic plug-ins, which will cause some less references to become invalid.

## Convert css-module

But as a plug-in that changes the theme, it is necessary to ensure that the class name is fixed, but not repeated. We performed two treatments. First, the class name is customized. This can be done easily by using the api `getLocalIdent` of `css-module`. This is how pro handles it.

```js
const getLocalIdent = (context, localIdentName, localName) => {
  if (
    context.resourcePath.includes('node_modules') ||
    context.resourcePath.includes('ant.design.pro.less') ||
    // umi's global.less convention does not use css-module
    context.resourcePath.includes('global.less')
  ) {
    return localName;
  }

  // Convert the class name of uuid to the style of antd-pro-file path.
  // similar. antd-pro-components-global-footer-index-links
  const match = context.resourcePath.match(/src(.*)/);
  if (match && match[1]) {
    const antdProPath = match[1].replace('.less', '');
    const arr = slash(antdProPath)
      .split('/')
      .map((a) => a.replace(/([A-Z])/g, '-$1'))
      .map((a) => a.toLowerCase());
    return `antd-pro${arr.join('-')}-${localName}`.replace(/--/g, '-');
  }
  return localName;
};
```

In this way, as long as the class name is generated in the same way when extracting less, it can be guaranteed that the two are the same.

> [`postcss-less-engine` ](https://www.npmjs.com/package/postcss-less-engine) is used here, you can generate less syntax tree and modify it.

## Extract less variables

This step is done through `antd-theme-webpack-plugin`. It traverses the syntax tree of less, extracts all selectors with less variables in the configuration, and combines them into a color.less file. [antd-theme-generator](git://github.com/mzohaibqc/antd-theme-generator) can view the specific implementation.

After extracting color.less, add the introduction of less to the html generated by the build through the ability of webpack. The default is

```html
<script
  type="text/javascript"
  src="https://gw.alipayobjects.com/os/lib/less.js/3.8.1/less.min.js"
></script>
```

When you need to change the theme, you can compile the referenced less by calling `window.less.modifyVars`.

```js
// Because the compilation time is too long and will block the rendering, please add hints.
window.less
  .modifyVars({
    '@primary-color': primaryColor,
  })
  .then(() => {
    // compile successfully
  })
  .catch(() => {
    // compilation failed
  });
```

## Existing problems

Using the above scheme can realize the function of changing the theme online, but at the same time introduce some new problems. Therefore, we do not recommend using it in a production environment. He will be perfected again in Pro v4.

First of all, `antd-pro-merge-less` will cause part of the introduction of less to fail. And it is difficult to troubleshoot. Compiling, merging and extracting less will cause the hot update speed to slow down or freeze during development. These will affect the development experience. Secondly, compiling less in the browser is not a very good solution. The compilation of less will cause the main process of the browser to freeze, which shows that the entire page is stuck. The experience is very poor.

The way `antd-theme-webpack-plugin` extracts variables also has some problems. The compiled css does not perform well in small details. It is far less perfect than modifying it in webpack compilation.

## Future improvements

The current online theme change is a demo program, which has some problems and is not suitable for adapting in a formal environment. We will improve his performance in v4. First, use a more elegant solution to merge and extract less. Supports the full features of less, so that it will not cause pits in the development, but will reduce the impact on the development experience.

The extraction variable algorithm in `antd-theme-webpack-plugin` will also be optimized to speed up, and will not be extracted after compiling once. In a formal environment, multiple copies of css will be compiled and dynamically imported css to change themes, which is smoother. The experience is better. At the same time, the plug-ins are merged. Now the three plug-ins are seriously coupled and do not support hot-plugging and downgrading schemes.
